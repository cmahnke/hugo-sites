{{- $hugoSites := slice }}

{{- $regexGenerator := `(?s)<meta\s+name="?generator"?\s+content="Hugo\s.+?"\s*/?>` }}
{{- $regexMetaDesc := `(?s)<meta\s+name="?description"?\s+content=".*?"\s*/?>` }}
{{- $regexOGDesc := `(?s)<meta\s+property="?og:description"?\s+content=".*?"\s*/?>` }}
{{- $regexTitle := `(?s)<title>.*?</title>` }}

{{- range $p := . }}

  {{- $description := "" }}
  {{- $host := .Title }}
  {{- $title := "" }}
  {{- $version := "" }}
  {{- $url := printf "https://%s/" (path.Join .Title .Params.path) }}

  {{- with resources.GetRemote $url }}
    {{- with .Err }}
      {{- errorf "Unable to reach %s: %s" $url . }}
    {{- else }}

      {{- /* Get version. */}}
      {{- with findRE $regexGenerator .Content }}
        {{- with index . 0 }}
          {{- $version = replaceRE `.*"Hugo\s+(.*)".*` "$1" . }}
        {{- end }}
      {{- else }}
        {{ if not site.Params.show_all }}
          {{- /* Hugo may have not built this site. */}}
          {{- continue }}
        {{ end }}
      {{- end }}

      {{- /* Get description from OpenGraph data. */}}
      {{- with findRE $regexOGDesc .Content }}
        {{- with index . 0 }}
          {{- $description = replaceRE `(?s).*content="(.*)".*` "$1" . | safeHTML }}
        {{- end }}
      {{- else }}
      {{- /* Get description from meta element. */}}
        {{- with findRE $regexMetaDesc .Content }}
          {{- with index . 0 }}
            {{- $description = replaceRE `(?s).*content="(.*)".*` "$1" . | safeHTML }}
          {{- end }}
        {{- end }}
      {{- end }}

      {{- /* Get title. */}}
      {{- with findRE $regexTitle .Content }}
        {{- with index . 0 }}
          {{- $title = replaceRE `(?s)<title>(.*)</title>` "$1" . | safeHTML }}
        {{- end }}
      {{- end }}

      {{- /* Get types. */}}
      {{- $types := "" }}
      {{- with $p.GetTerms "types" }}
        {{- range $k, $_ := . }}
          {{- if $k }}
            {{- $types = print $types ", " }}
          {{- end }}
          {{- $types = print $types (printf "<a href=%q>%s</a>" .RelPermalink .LinkTitle)}}
        {{- end }}
      {{- end }}

      {{- /* Get visibility. */}}
      {{- $visibility := "" }}
      {{- with $p.GetTerms "visibility" }}
        {{- range $k, $_ := . }}
          {{- if $k }}
            {{- $visibility = print $visibility ", " }}
          {{- end }}
          {{- $visibility = print $visibility (printf "<a href=%q>%s</a>" .RelPermalink .LinkTitle)}}
        {{- end }}
      {{- end }}


      {{- /* Build map of sites. */}}
      {{- $hugoSites = $hugoSites | append (dict
        "description" (trim $description "\n")
        "host" $host
        "title" (trim $title "\n")
        "types" $types
        "url" $url
        "version" $version
        "visibility" $visibility
        )
      }}

    {{- end }}
  {{- else }}
    {{- errorf "Unable to reach %s" . }}
  {{- end }}
{{- end }}

{{- with $hugoSites }}
  <table>
    <thead>
      <tr>
        <th>Host</th>
        <th>Title</th>
        <th>Types</th>
        <th>Visibility</th>
        <th>Version</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
      {{- range . }}
        <tr>
          <td><a href="{{ .url }}" target="_blank">{{ .host }}</a></td>
          <td>{{- .title | safeHTML }}</td>
          <td>{{- .types | safeHTML }}</td>
          <td>{{- .visibility | safeHTML }}</td>
          <td>{{- .version }}</td>
          <td>{{- .description | safeHTML }}</td>
        </tr>
      {{- end }}
    </tbody>
  </table>
{{ end -}}
