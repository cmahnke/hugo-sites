{{- $hugoSites := slice }}

{{- /* Use \x22 instead of double quote to get around VS Code syntax highlighting bug. */}}
{{- $regexDescMeta := `(?s)<meta\s+(?:itemprop|name)=\s*(\x22|')?description(\x22|')?\s+content=\s*(\x22|')?.*?(\x22|')?\s*/?>`  }}
{{- $regexDescOG :=  `(?s)<meta\s+property=\s*(\x22|')?og:description(\x22|')?\s+content=\s*(\x22|')?.*?(\x22|')?\s*/?>` }}
{{- $regexDescValue :=  `(?s).*content=\s*(?:\x22|')?(.*?)(?:\x22|').*` }}
{{- $regexTitle := `(?s)<title>.*?</title>` }}
{{- $regexTitleValue := `(?s)<title>(.*)</title>` }}
{{- $regexVersion := `(?s)<meta\s+name="?generator"?\s+content="Hugo\s.+?"\s*/?>` }}
{{- $regexVersionValue := `.*"Hugo\s+(.*)".*` }}

{{- range $p := . }}

  {{- $description := "" }}
  {{- $host := .Title }}
  {{- $title := "" }}
  {{- $version := "" }}
  {{- $url := printf "https://%s/" (path.Join .Title .Params.path) }}

  {{- with resources.GetRemote $url }}
    {{- with .Err }}
      {{- errorf "Unable to reach %s: %s" $url . }}
    {{- else }}

      {{- /* Get version. */}}
      {{- with findRE $regexVersion .Content }}
        {{- with index . 0 }}
          {{- $version = replaceRE $regexVersionValue "$1" . }}
        {{- end }}
      {{- else }}
        {{- if not site.Params.show_all }}
          {{- /* Hugo may have not built this site. */}}
          {{- continue }}
        {{- end }}
      {{- end }}

      {{- /* Get description from OpenGraph data. */}}
      {{- with findRE $regexDescOG .Content }}
        {{- with index . 0 }}
          {{- $description = replaceRE $regexDescValue "$1" . | safeHTML }}
        {{- end }}
      {{- else }}
        {{- /* Get description from meta element. */}}
        {{- with findRE $regexDescMeta .Content }}
          {{- with index . 0 }}
            {{- $description = replaceRE $regexDescValue "$1" . | safeHTML }}
          {{- end }}
        {{- end }}
      {{- end }}

      {{- /* Get title. */}}
      {{- with findRE $regexTitle .Content }}
        {{- with index . 0 }}
          {{- $title = replaceRE $regexTitleValue "$1" . | safeHTML }}
        {{- end }}
      {{- end }}

      {{- /* Get types. */}}
      {{- $types := "" }}
      {{- with $p.GetTerms "types" }}
        {{- range $k, $_ := . }}
          {{- if $k }}
            {{- $types = print $types ", " }}
          {{- end }}
          {{- $types = print $types (printf "<a href=%q>%s</a>" .RelPermalink .LinkTitle) }}
        {{- end }}
      {{- end }}

      {{- /* Get visibility. */}}
      {{- $visibility := "" }}
      {{- with $p.GetTerms "visibility" }}
        {{- range $k, $_ := . }}
          {{- if $k }}
            {{- $visibility = print $visibility ", " }}
          {{- end }}
          {{- $visibility = print $visibility (printf "<a href=%q>%s</a>" .RelPermalink .LinkTitle) }}
        {{- end }}
      {{- end }}


      {{- /* Build map of sites. */}}
      {{- $hugoSites = $hugoSites | append (dict
        "description" (trim $description "\n")
        "host" $host
        "title" (trim $title "\n")
        "types" $types
        "url" $url
        "version" $version
        "visibility" $visibility
        )
      }}

    {{- end }}
  {{- else }}
    {{- errorf "Unable to reach %s" . }}
  {{- end }}
{{- end }}

{{- with $hugoSites }}
  <table>
    <thead>
      <tr>
        <th>Host</th>
        <th>Title</th>
        <th>Types</th>
        <th>Visibility</th>
        <th>Version</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
      {{- range . }}
        <tr>
          <td><a href="{{ .url }}" target="_blank">{{ .host }}</a></td>
          <td>{{- .title | safeHTML }}</td>
          <td>{{- .types | safeHTML }}</td>
          <td>{{- .visibility | safeHTML }}</td>
          <td>{{- .version }}</td>
          <td>{{- .description | safeHTML }}</td>
        </tr>
      {{- end }}
    </tbody>
  </table>
{{- end -}}
